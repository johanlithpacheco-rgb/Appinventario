<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Inventario - Repuestos</title>
  <style>
    :root{
      --bg:#f3f6fb; --card:#fff; --accent:#4f46e5; --danger:#dc2626; --muted:#6b7280;
      --success:#16a34a; --shadow:0 2px 12px rgba(16,24,40,0.08);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,Arial,sans-serif;margin:0;
      background:linear-gradient(180deg,#eef2ff 0%,#f3f6fb 100%);color:#111;padding-bottom:80px}
    
    /* Header fijo */
    header{position:sticky;top:0;background:linear-gradient(180deg,#4f46e5 0%,#4338ca 100%);
      color:#fff;padding:16px;box-shadow:var(--shadow);z-index:30}
    header h1{margin:0;font-size:18px;font-weight:600}
    header .subtitle{font-size:12px;opacity:0.9;margin-top:4px}
    
    /* Stats */
    .stats-bar{display:flex;gap:8px;padding:12px 16px;background:#fff;
      box-shadow:var(--shadow);overflow-x:auto}
    .stat{flex:1;min-width:100px;padding:12px;border-radius:10px;background:#f9fafb;text-align:center}
    .stat .label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
    .stat .num{font-weight:700;font-size:22px;color:var(--accent);margin-top:4px}
    
    /* Tabs navegaci√≥n */
    .tabs{display:flex;background:#fff;border-bottom:1px solid #e5e7eb;position:sticky;top:68px;z-index:25}
    .tab{flex:1;padding:14px;text-align:center;border:none;background:transparent;
      font-size:14px;font-weight:500;color:var(--muted);cursor:pointer;position:relative}
    .tab.active{color:var(--accent)}
    .tab.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;
      background:var(--accent);border-radius:3px 3px 0 0}
    
    /* Container */
    .container{padding:16px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:var(--shadow);margin-bottom:12px}
    
    /* Controles m√≥viles */
    .search-box{position:relative;margin-bottom:12px}
    .search-box input{width:100%;padding:12px 12px 12px 42px;border:1px solid #e5e7eb;
      border-radius:12px;font-size:16px;background:#fafafa}
    .search-box svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:0.5}
    
    .filter-bar{display:flex;gap:8px;margin-bottom:12px;overflow-x:auto;padding:2px}
    .filter-chip{padding:8px 14px;border-radius:20px;border:1px solid #e5e7eb;
      background:#fff;font-size:13px;white-space:nowrap;cursor:pointer;
      display:inline-flex;align-items:center;gap:6px}
    .filter-chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    
    /* Grid productos - optimizado m√≥vil */
    .products-list{display:flex;flex-direction:column;gap:10px}
    .product-card{background:#fff;border-radius:12px;padding:14px;
      box-shadow:0 1px 4px rgba(0,0,0,0.06);border:1px solid #f1f5f9}
    .product-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
    .product-info h3{margin:0;font-size:15px;font-weight:600;line-height:1.3}
    .product-meta{font-size:12px;color:var(--muted);margin-top:4px}
    .alert-icon{color:var(--danger);font-size:20px;flex-shrink:0}
    
    .product-stats{display:flex;align-items:center;justify-content:space-between;
      margin:12px 0;padding-top:12px;border-top:1px solid #f1f5f9}
    .stock-display{display:flex;align-items:baseline;gap:6px}
    .stock-num{font-size:28px;font-weight:700}
    .stock-num.low{color:var(--danger)}
    .stock-label{font-size:11px;color:var(--muted);text-transform:uppercase}
    .min-stock{text-align:right;font-size:12px;color:var(--muted)}
    
    .product-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
    
    /* Botones t√°ctiles */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 16px;border-radius:10px;border:none;cursor:pointer;
      font-size:14px;font-weight:500;min-height:44px;transition:transform 0.1s}
    .btn:active{transform:scale(0.97)}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.success{background:var(--success);color:#fff}
    .btn.danger{background:#fff;color:var(--danger);border:2px solid var(--danger)}
    .btn.ghost{background:#f9fafb;border:1px solid #e5e7eb}
    
    /* Historial m√≥vil */
    .movement-item{background:#fff;border-radius:10px;padding:12px;
      margin-bottom:8px;border-left:4px solid #e5e7eb}
    .movement-item.in{border-left-color:var(--success)}
    .movement-item.out{border-left-color:var(--danger)}
    .movement-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
    .movement-product{font-weight:600;font-size:14px}
    .movement-date{font-size:11px;color:var(--muted)}
    .movement-details{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;
      padding-top:8px;border-top:1px solid #f1f5f9}
    .detail-item{text-align:center}
    .detail-label{font-size:10px;color:var(--muted);text-transform:uppercase}
    .detail-value{font-size:15px;font-weight:600;margin-top:2px}
    .pill{display:inline-block;padding:4px 10px;border-radius:12px;
      font-size:11px;font-weight:500}
    .pill.in{background:#ecfdf5;color:var(--success)}
    .pill.out{background:#fff1f2;color:var(--danger)}
    
    /* Modal pantalla completa en m√≥vil */
    .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.5);
      display:flex;align-items:flex-end;justify-content:center;z-index:50;
      animation:fadeIn 0.2s}
    .modal{width:100%;max-height:85vh;background:var(--card);
      border-radius:20px 20px 0 0;overflow:hidden;
      animation:slideUp 0.3s;display:flex;flex-direction:column}
    .modal-header{padding:16px;border-bottom:1px solid #e5e7eb;
      display:flex;justify-content:space-between;align-items:center}
    .modal-header h3{margin:0;font-size:18px}
    .modal-body{padding:16px;overflow-y:auto;flex:1}
    .modal-footer{padding:16px;border-top:1px solid #e5e7eb;background:#fafafa}
    
    .form-row{margin-bottom:14px}
    .form-row label{display:block;font-size:13px;margin-bottom:6px;
      color:var(--muted);font-weight:500}
    .form-row input,.form-row textarea,.form-row select{width:100%;padding:12px;
      border-radius:10px;border:1px solid #e5e7eb;font-size:16px}
    .form-row input:focus,.form-row textarea:focus{outline:none;
      border-color:var(--accent);box-shadow:0 0 0 3px rgba(79,70,229,0.1)}
    
    /* FAB - Floating Action Button */
    .fab{position:fixed;bottom:20px;right:20px;width:56px;height:56px;
      border-radius:50%;background:var(--accent);color:#fff;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 4px 16px rgba(79,70,229,0.4);border:none;
      cursor:pointer;font-size:24px;z-index:40;transition:transform 0.2s}
    .fab:active{transform:scale(0.9)}
    
    /* Animaciones */
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    
    /* Badge */
    .badge{display:inline-block;padding:4px 8px;border-radius:6px;
      font-size:11px;background:#eef2ff;color:var(--accent);font-weight:500}
    
    /* Empty state */
    .empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
    .empty-state svg{width:64px;height:64px;opacity:0.3;margin-bottom:12px}
    
    /* Desktop */
    @media (min-width:768px){
      body{padding-bottom:0}
      .container{max-width:1200px;margin:0 auto;padding:20px}
      header{position:relative;border-radius:12px;margin:20px auto;max-width:1200px}
      .tabs{position:relative;top:0;border-radius:12px;margin-bottom:16px}
      .products-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
      .modal-back{align-items:center}
      .modal{max-width:520px;border-radius:16px;max-height:90vh}
      .fab{display:none}
      .stats-bar{border-radius:12px;margin-bottom:16px}
    }
  </style>
</head>
<body>
  <header>
    <h1>üì± Inventario Repuestos</h1>
    <div class="subtitle">Taller de Reparaciones</div>
  </header>

  <div class="stats-bar">
    <div class="stat">
      <div class="label">Productos</div>
      <div class="num" id="totalProductos">0</div>
    </div>
    <div class="stat">
      <div class="label">Alertas</div>
      <div class="num" style="color:var(--danger)" id="totalAlertas">0</div>
    </div>
    <div class="stat">
      <div class="label">Movimientos</div>
      <div class="num" id="totalMovimientos">0</div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="productos">üì¶ Productos</button>
    <button class="tab" data-tab="historial">üìä Historial</button>
  </div>

  <!-- Tab: Productos -->
  <div id="tabProductos" class="container">
    <div class="search-box">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="M21 21l-4.35-4.35" stroke="#6b7280" stroke-width="2" stroke-linecap="round"/>
        <circle cx="11" cy="11" r="6" stroke="#6b7280" stroke-width="2"/>
      </svg>
      <input id="search" placeholder="Buscar producto o SKU..." />
    </div>

    <div class="filter-bar">
      <button class="filter-chip" data-filter="todos">üìã Todos</button>
      <button class="filter-chip" data-filter="alerta">‚ö†Ô∏è En alerta</button>
      <button class="filter-chip" data-filter="pantallas">üì± Pantallas</button>
      <button class="filter-chip" data-filter="baterias">üîã Bater√≠as</button>
      <button class="filter-chip" data-filter="componentes">üîß Componentes</button>
    </div>

    <div class="products-list" id="productosLista"></div>
  </div>

  <!-- Tab: Historial -->
  <div id="tabHistorial" class="container" style="display:none">
    <div id="movimientosLista"></div>
  </div>

  <!-- FAB -->
  <button class="fab" id="fabAdd" title="Agregar producto">+</button>

  <!-- Modal -->
  <div id="modalRoot" style="display:none"></div>

  <script>
    (function(){
      // Datos de ejemplo
      const ejemploProductos = [
        { id: 1, nombre: 'Pantalla Samsung A10', sku: 'PNT-A10', stock: 12, categoria: 'Pantallas', minimo: 5, proveedor: 'Distribuidor A' },
        { id: 2, nombre: 'Pantalla iPhone 11', sku: 'PNT-IP11', stock: 7, categoria: 'Pantallas', minimo: 3, proveedor: 'Distribuidor B' },
        { id: 3, nombre: 'Bater√≠a Samsung A20', sku: 'BAT-A20', stock: 2, categoria: 'Bater√≠as', minimo: 10, proveedor: 'Distribuidor A' },
        { id: 4, nombre: 'Puerto de carga Redmi 9', sku: 'PRC-R9', stock: 22, categoria: 'Componentes', minimo: 6, proveedor: 'Distribuidor C' },
        { id: 5, nombre: 'Bocina iPhone X', sku: 'BCN-IPX', stock: 4, categoria: 'Componentes', minimo: 5, proveedor: 'Distribuidor D' },
        { id: 6, nombre: 'Mica Templada Universal', sku: 'MCA-UNI', stock: 50, categoria: 'Accesorios', minimo: 20, proveedor: 'Accesorios S.A.' }
      ];

      const KEY_PRODUCTS = 'inv_repuestos_products_v2';
      const KEY_MOVS = 'inv_repuestos_movs_v2';

      // DOM
      const productosLista = document.getElementById('productosLista');
      const movimientosLista = document.getElementById('movimientosLista');
      const searchInput = document.getElementById('search');
      const totalProductos = document.getElementById('totalProductos');
      const totalAlertas = document.getElementById('totalAlertas');
      const totalMovimientos = document.getElementById('totalMovimientos');
      const modalRoot = document.getElementById('modalRoot');
      const fabAdd = document.getElementById('fabAdd');
      const tabProductos = document.getElementById('tabProductos');
      const tabHistorial = document.getElementById('tabHistorial');

      // Estado
      let productos = load(KEY_PRODUCTS) || ejemploProductos;
      let movimientos = load(KEY_MOVS) || [];
      let filtroTexto = '';
      let filtroCategoria = 'todos';
      let tabActual = 'productos';

      // Utils
      function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
      function load(key){ try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : null } catch(e){ return null } }
      function formatDate(d){ return new Date(d).toLocaleString('es-CO', {day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}); }
      function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) ); }

      // Render productos
      function renderProductos(){
        const q = filtroTexto.trim().toLowerCase();
        let lista = productos.filter(p=>{
          if(!q) return true;
          return p.nombre.toLowerCase().includes(q) || p.sku.toLowerCase().includes(q);
        });

        if(filtroCategoria === 'alerta'){
          lista = lista.filter(p => p.stock <= p.minimo);
        } else if(filtroCategoria !== 'todos'){
          const cat = filtroCategoria.charAt(0).toUpperCase() + filtroCategoria.slice(1);
          lista = lista.filter(p => p.categoria.toLowerCase().includes(filtroCategoria));
        }

        productosLista.innerHTML = '';
        if(lista.length === 0){
          productosLista.innerHTML = '<div class="empty-state">üì¶ No hay productos</div>';
        } else {
          lista.forEach(p=>{
            const enAlerta = p.stock <= p.minimo;
            const div = document.createElement('div');
            div.className = 'product-card';
            div.innerHTML = `
              <div class="product-header">
                <div class="product-info">
                  <h3>${escapeHtml(p.nombre)}</h3>
                  <div class="product-meta">
                    <span class="badge">${escapeHtml(p.sku)}</span>
                    <span style="margin:0 6px">‚Ä¢</span>
                    <span>${escapeHtml(p.categoria)}</span>
                  </div>
                </div>
                ${enAlerta ? '<div class="alert-icon">‚ö†Ô∏è</div>' : ''}
              </div>
              <div class="product-stats">
                <div class="stock-display">
                  <div>
                    <div class="stock-num ${enAlerta?'low':''}">${p.stock}</div>
                    <div class="stock-label">Stock</div>
                  </div>
                </div>
                <div class="min-stock">
                  M√≠nimo: <strong>${p.minimo}</strong><br>
                  <span style="font-size:11px">${escapeHtml(p.proveedor||'-')}</span>
                </div>
              </div>
              <div class="product-actions">
                <button class="btn success" data-action="entrada" data-id="${p.id}">‚ûï Entrada</button>
                <button class="btn danger" data-action="salida" data-id="${p.id}">‚ûñ Salida</button>
              </div>
            `;
            productosLista.appendChild(div);
          });
        }

        totalProductos.textContent = productos.length;
        totalAlertas.textContent = productos.filter(p => p.stock <= p.minimo).length;
      }

      // Render movimientos
      function renderMovimientos(){
        movimientosLista.innerHTML = '';
        if(movimientos.length === 0){
          movimientosLista.innerHTML = '<div class="empty-state">üìä Sin movimientos</div>';
        } else {
          movimientos.forEach(m=>{
            const div = document.createElement('div');
            div.className = `movement-item ${m.tipo}`;
            div.innerHTML = `
              <div class="movement-header">
                <div>
                  <div class="movement-product">${escapeHtml(m.producto)}</div>
                  <div class="product-meta">${escapeHtml(m.sku)}</div>
                </div>
                <span class="pill ${m.tipo}">${m.tipo==='entrada'?'Entrada':'Salida'}</span>
              </div>
              <div class="movement-details">
                <div class="detail-item">
                  <div class="detail-label">Cantidad</div>
                  <div class="detail-value">${m.cantidad}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Antes</div>
                  <div class="detail-value">${m.stockAnterior}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Ahora</div>
                  <div class="detail-value">${m.stockNuevo}</div>
                </div>
              </div>
              ${m.notas ? `<div style="margin-top:8px;font-size:12px;color:var(--muted)">üìù ${escapeHtml(m.notas)}</div>` : ''}
              <div class="movement-date" style="margin-top:6px">${formatDate(m.fecha)}</div>
            `;
            movimientosLista.appendChild(div);
          });
        }
        totalMovimientos.textContent = movimientos.length;
      }

      // Eventos
      productosLista.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-action]');
        if(!btn) return;
        const id = Number(btn.dataset.id);
        const tipo = btn.dataset.action;
        const producto = productos.find(x=>x.id===id);
        if(!producto) return;
        openMovimientoModal(producto, tipo);
      });

      searchInput.addEventListener('input', (e)=>{
        filtroTexto = e.target.value;
        renderProductos();
      });

      // Filtros
      document.querySelectorAll('.filter-chip').forEach(chip=>{
        chip.addEventListener('click', ()=>{
          document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));
          chip.classList.add('active');
          filtroCategoria = chip.dataset.filter;
          renderProductos();
        });
      });

      // Tabs
      document.querySelectorAll('.tab').forEach(tab=>{
        tab.addEventListener('click', ()=>{
          document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
          tab.classList.add('active');
          tabActual = tab.dataset.tab;
          if(tabActual === 'productos'){
            tabProductos.style.display = 'block';
            tabHistorial.style.display = 'none';
            fabAdd.style.display = 'flex';
          } else {
            tabProductos.style.display = 'none';
            tabHistorial.style.display = 'block';
            fabAdd.style.display = 'none';
            renderMovimientos();
          }
        });
      });

      fabAdd.addEventListener('click', ()=> openAddProductModal());

      // Modales
      function openMovimientoModal(producto, tipo){
        showModal(`
          <div class="modal-header">
            <h3>${tipo === 'entrada' ? '‚ûï Entrada' : '‚ûñ Salida'}</h3>
            <button id="closeModal" class="btn ghost" style="min-height:36px;padding:8px 12px">‚úï</button>
          </div>
          <div class="modal-body">
            <div class="card">
              <div><strong>${escapeHtml(producto.nombre)}</strong></div>
              <div class="product-meta">SKU: ${escapeHtml(producto.sku)} ‚Ä¢ Stock: <strong>${producto.stock}</strong></div>
            </div>
            <div class="form-row">
              <label>Cantidad</label>
              <input type="number" id="movCantidad" min="1" value="1" inputmode="numeric"/>
            </div>
            <div class="form-row">
              <label>Notas (opcional)</label>
              <textarea id="movNotas" rows="3" placeholder="Motivo del movimiento..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button id="confirmMov" class="btn ${tipo==='entrada'?'success':'danger'}" style="width:100%">
              ${tipo === 'entrada' ? '‚úì Registrar Entrada' : '‚úì Registrar Salida'}
            </button>
          </div>
        `);

        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('confirmMov').addEventListener('click', ()=>{
          const qty = Number(document.getElementById('movCantidad').value || 0);
          const notas = document.getElementById('movNotas').value.trim();
          if(!qty || qty <= 0){ alert('Ingresa una cantidad v√°lida'); return; }
          const nuevoStock = tipo === 'entrada' ? producto.stock + qty : producto.stock - qty;
          if(nuevoStock < 0){ alert('Stock insuficiente'); return; }

          productos = productos.map(p => p.id === producto.id ? {...p, stock: nuevoStock} : p);
          save(KEY_PRODUCTS, productos);

          const mov = {
            id: Date.now(),
            productoId: producto.id,
            producto: producto.nombre,
            sku: producto.sku,
            tipo,
            cantidad: qty,
            stockAnterior: producto.stock,
            stockNuevo: nuevoStock,
            fecha: Date.now(),
            notas: notas
          };
          movimientos.unshift(mov);
          save(KEY_MOVS, movimientos);

          renderProductos();
          renderMovimientos();
          closeModal();
        });
      }

      function openAddProductModal(){
        showModal(`
          <div class="modal-header">
            <h3>‚ûï Nuevo Producto</h3>
            <button id="closeModal" class="btn ghost" style="min-height:36px;padding:8px 12px">‚úï</button>
          </div>
          <div class="modal-body">
            <div class="form-row"><label>Nombre *</label><input id="pNombre" placeholder="Ej: Pantalla iPhone 12"/></div>
            <div class="form-row"><label>SKU *</label><input id="pSku" placeholder="Ej: PNT-IP12"/></div>
            <div class="form-row"><label>Categor√≠a</label>
              <select id="pCat">
                <option>Pantallas</option>
                <option>Bater√≠as</option>
                <option>Componentes</option>
                <option>Accesorios</option>
              </select>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div class="form-row"><label>Stock inicial</label><input id="pStock" type="number" min="0" value="0" inputmode="numeric"/></div>
              <div class="form-row"><label>Stock m√≠nimo</label><input id="pMin" type="number" min="0" value="5" inputmode="numeric"/></div>
            </div>
            <div class="form-row"><label>Proveedor</label><input id="pProv" placeholder="Nombre del proveedor"/></div>
          </div>
          <div class="modal-footer">
            <button id="confirmAdd" class="btn primary" style="width:100%">‚úì Agregar Producto</button>
          </div>
        `);

        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('confirmAdd').addEventListener('click', ()=>{
          const nombre = document.getElementById('pNombre').value.trim();
          const sku = document.getElementById('pSku').value.trim();
          const categoria = document.getElementById('pCat').value;
          const stock = Number(document.getElementById('pStock').value) || 0;
          const minimo = Number(document.getElementById('pMin').value) || 1;
          const proveedor = document.getElementById('pProv').value.trim();

          if(!nombre || !sku){ alert('Nombre y SKU son obligatorios'); return; }
          if(productos.some(p => p.sku.toLowerCase() === sku.toLowerCase())){
            if(!confirm('Ya existe un producto con ese SKU. ¬øContinuar?')) return;
          }

          const nuevo = { id: Date.now(), nombre, sku, categoria, stock, minimo, proveedor };
          productos.unshift(nuevo);
          save(KEY_PRODUCTS, productos);
          renderProductos();
          closeModal();
        });
      }

      // Modal helpers
      function showModal(html){
        modalRoot.innerHTML = '';
        const wrap = document.createElement('div');
        wrap.className = 'modal-back';
        wrap.innerHTML = `<div class="modal">${html}</div>`;
        modalRoot.appendChild(wrap);
        modalRoot.style.display = 'block';
        wrap.addEventListener('click', (e)=>{ if(e.target === wrap) closeModal(); });
      }
      function closeModal(){ modalRoot.style.display = 'none'; modalRoot.innerHTML = ''; }

      // Init
      renderProductos();
      renderMovimientos();
    })();
  </script>
</body>
</html>